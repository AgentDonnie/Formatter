<html>
<head>
<meta charset="UTF-8">
<script
  src="https://code.jquery.com/jquery-3.7.1.js">
</script>
<script>
let filters=[];
let specials=[];
let main_text=[];
let mainold_text=[];
const srtline = [];

//♪ – ñ


//Masked Singer
addFilter("&msp", "Masked Singer Pilipinas");
addFilter("&ms", "Masked Singer"); // 10 lines
addFilter("&mu", "Masked Universe");
addFilter("&jd", "Judge Detective");
addFilter("&hm", "Hula Maskedster");

//sounds
addFilter("&kod", "knocking on door");
addFilter("&icg", "indistinct chattering");
addFilter("&ic", "indistinct chatter");

//music
addFilter("&umpg", "upbeat music playing");
addFilter("&ompg", "ominous music playing");
addFilter("&smpg", "suspenseful music playing");

addFilter("&mpg", "music playing");
addFilter("&mp", "music play");

addFilter("&lg", "laughing");
addFilter("&l", "laugh");

//Special Tags
addSpecial("&ddd", "♪♪♪");
addSpecial("[[", "<i>♪ ");
addSpecial("]]", " ♪<\/i>");
addSpecial("[[", "♪ ");
addSpecial("]]", " ♪");

addSpecial("(TL)", "{\\an7}");
addSpecial("(TC)", "{\\an8}");
addSpecial("(TR)", "{\\an9}");
addSpecial("(CL)", "{\\an4}");
addSpecial("(CC)", "{\\an5}");
addSpecial("(CR)", "{\\an6}");
addSpecial("(BL)", "{\\an1}");
addSpecial("(BR)", "{\\an3}");

addSpecial("(tl)", "{\\an7}");
addSpecial("(tc)", "{\\an8}");
addSpecial("(tr)", "{\\an9}");
addSpecial("(cl)", "{\\an4}");
addSpecial("(cc)", "{\\an5}");
addSpecial("(cr)", "{\\an6}");
addSpecial("(bl)", "{\\an1}");
addSpecial("(br)", "{\\an3}");

//***

addFilter(/“/i, "''");
addFilter(/”/i, "''");
addFilter(/"/i, "''");
addFilter(/"/i, "''");
addFilter(/’/i, "'");
addFilter("‘", "'");
addFilter("‚", ",");
addFilter("‹", "'");
addFilter("›", "'");
addFilter(/…/i, "...");
addFilter("Ñ", "N");
addFilter("É", "E");
addFilter("È", "E");
addFilter("è", "e");
addFilter("é", "e");
addFilter("´", "'");
addFilter("′", "'");
addFilter("″", "''");
addFilter("•", "*");

addFilter("..", "...");
addFilter(" ...", "...");
addFilter("....", "...");
addFilter(".....", "...");

//punc
addFilter(" , ", ", ");
addFilter(" ! ", "! ");
addFilter(" . ", ". ");
//addFilter(" - ", "-");

//addFilter(/ !/i, "!");
//addFilter(/ ?/i, "?");

//regular words
/*
addFilter(/\bcause\b/i, "'cause");

addFilter(/\bi\b/i, "I");
addFilter(/\bi'm\b/i, "I'm");
addFilter(/\bim\b/i, "I'm");
addFilter(/\bi'll\b/i, "I'll");
addFilter(/\bill\b/i, "I'll");
addFilter(/\bi've\b/i, "I've");
addFilter(/\bive\b/i, "I've");
addFilter(/\bi'd\b/i, "I'd");
addFilter(/\bid\b/i, "I'd");

addFilter(/\byoure\b/i, "You're");
addFilter("Guys ", "Guys, ");
addFilter("Bye ", "Bye, ");
addFilter("Okay ", "Okay, ");
addFilter("Hi ", "Hi, ");
addFilter("Hey ", "Hey, ");
addFilter("Yes ", "Yes, ");
addFilter("Thanks ", "Thanks, ");
addFilter("Alright ", "Alright, ");
addFilter("Finally ", "Finally, ");
addFilter("Well ", "Well, ");
addFilter("Actually ", "Actually, ");
addFilter("You know ", "You know, ");
addFilter("You know, what", "You know what");
addFilter("You know, what,", "You know what,");
addFilter("You know, what?", "You know what?");
addFilter("You know, me", "You know me");
addFilter("You know, him", "You know him");
addFilter("You know, her", "You know her");
addFilter("You know, it", "You know it");
addFilter("Ofcourse ", "Of course ");
addFilter("ofcourse ", "ofcourse ");
addFilter("Of course ", "Of course, ");
addFilter("Eh ", "Uh, ");
addFilter("Ay ", "Oh, ");
addFilter("Ah ", "Uh, ");
addFilter("Ah, ", "Uh, ");
addFilter("Uh ", "Uh, ");
addFilter("Ah ", "Uh, ");
addFilter("Uhm", "Um");
addFilter("Um ", "Um, ");
addFilter("Oh ", "Oh, ");
addFilter("coz ", "'coz ");
addFilter("Coz ", "'Coz ");
addFilter("So ", "So, ");
addFilter("Cause ", "'Cause, ");

addFilter(/pinoy/i, "Pinoy");
addFilter(/philippines/i, "Philippines");
*/

addFilter(/january/i, "January");
addFilter(/february/i, "February");
addFilter(/april/i, "April");
addFilter(/june/i, "June");
addFilter(/july/i, "July");
addFilter(/august/i, "August");
addFilter(/september/i, "September");
addFilter(/october/i, "October");
addFilter(/november/i, "November");
addFilter(/december/i, "december");

addFilter(/monday/i, "Monday");
addFilter(/tuesday/i, "Tuesday");
addFilter(/wednesday/i, "Wednesday");
addFilter(/thursday/i, "Thursday");
addFilter(/friday/i, "Friday");
addFilter(/saturday/i, "Saturday");
addFilter(/sunday/i, "Sunday");

addFilter(/christmas/i, "Christmas");
addFilter(/valentines/i, "Valentines");

function addSpecial(filter, change){
	specials.push([filter, change]);
}

function addFilter(filter, change){
	filters.push([filter, change]);
}

function setEmDash(b) {
  document.getElementById("EmDash").checked = b;
}

function capitalHIs(b){
	for(let i = 0; i<main_text.length; i++){
		let reg = /\[.*\]/
		if (main_text[i].match(reg)){
			
			let val = main_text[i].match(reg);
			
			for(let j = 0; j<val.length; j++){
				val[j] = val[j].toLowerCase();
				//console.log(b);
				if(b){
					val[j] = val[j].toUpperCase();
				}
			}
			
			main_text[i] = main_text[i].replace(main_text[i].match(reg),val);
		}
	}
}

function implementFilters(){
	//remove special charters
	//for(let i = 0; i<main_text.length; i++){
	//	for(let j = 0; j<filters.length; j++){
	//		main_text[i] = main_text[i].split(filters[j][0]).join(filters[j][1]);
	//	}
	//}
	
	
	for(let i = 0; i<srtline.length; i++){
		for(let x = 0; x<srtline[i].dialogs.length; x++){
			for(let j = 0; j<filters.length; j++){
				
				if (srtline[i].dialogs[x].match(filters[j][0])){
					srtline[i].dialogs[x] = srtline[i].dialogs[x].split(filters[j][0]).join(filters[j][1]);
					
					srtline[i].isChanged = true;
					
				}
			}
		}
	}
	
}

function specialTags(){
	if(!document.getElementById("mode").value == "mode_ahd"){
		for(let i = 0; i<srtline.length; i++){
			for(let x = 0; x<srtline[i].dialogs.length; x++){
				for(let j = 0; j<specials.length; j++){
					
					if (srtline[i].dialogs[x].includes(specials[j][0])){
						srtline[i].dialogs[x] = srtline[i].dialogs[x].split(specials[j][0]).join(specials[j][1]);
						
						srtline[i].note += "Tags Changed. ".trim();
						srtline[i].isChanged = true;
						
					}
				}
			}
		}
	}else{
		for(let i = 0; i<srtline.length; i++){
			for(let x = 0; x<srtline[i].dialogs.length; x++){
				for(let j = 0; j<specials.length; j++){
					
					if (srtline[i].dialogs[x].includes(specials[j][1])){
						srtline[i].dialogs[x] = srtline[i].dialogs[x].split(specials[j][1]).join(specials[j][0]);
						
						srtline[i].note += "Tags Reverted. ".trim();
						srtline[i].isChanged = true;
					}
				}
			}
		}
	}
}

function CapAftrerChar(s, val){
	let idx = s.indexOf(val);

	if(idx!=-1){
		idx = idx + val.length;
		if(idx<s.length){
			let got=s.split("");
			got[idx] = got[idx].toUpperCase();
			return got.join("");
		}
	}
	return s;
}

function CapHitFirstChar(s, bool){
	let got=s.split("");
	for(let i=0; i<s.length; i++){
		if(got[i].match(/[a-z]/i)){
			if(bool == true){
				got[i] = got[i].toUpperCase();
			} else if(bool == false){
				got[i] = got[i].toLowerCase();
			}
			return got.join("");
		}
	}
	return s;
}
		
function EnsureCapitalization(){
	for(let i = 0; i<main_text.length; i++){
		//main_text[i]=main_text[i].toLowerCase(); // use only for all caps translations
		// fix unahan and trailing spaces
		main_text[i]=main_text[i].replace(/^[ \t]+/igm,"");
	}
	
	let re = /(^|[.!?]\s+)([a-z])/g;
	for(let i = 0; i<main_text.length; i++){
		// capitalized after period, exclam and question mark.
		main_text[i] = main_text[i].replace(re, function (m, $1, $2) {
			return $1 + $2.toUpperCase();
		});
		main_text[i]=CapHitFirstChar(main_text[i], true); // capitalize small first
	}
	
	let reg = /,$/igm;
	for(let i = 0; i<main_text.length; i++){
		//When all first char is capitalize, respect comma.
		if(reg.test(main_text[i]) || main_text[i].substring(main_text[i].length-2,main_text[i].length-1) == ","){
			main_text[i+1]=CapHitFirstChar(main_text[i+1], false);
			//alert(main_text[i+1]);
		}
	}
	
	for(let i = 0; i<main_text.length; i++){
		// kapag nasa loob ng quote, capitalize.
		main_text[i] = CapAftrerChar(main_text[i], "''");
		main_text[i] = CapAftrerChar(main_text[i], "\"");
	}
}

function convertMusicNote(){
	for(let i = 0; i<main_text.length; i++){
		if(main_text[i].includes("(dd)")){
			main_text[i] = main_text[i].replace("(dd)", "<i>♪ ") + " ♪</i>";
			mainold_text[i] = main_text[i];
		}
	}
	
	//mainold_text = main_text;
}

function convertEmDash(){
	if(!document.getElementById("revert_specials").checked){
		if (document.getElementById("EmDash").checked){
			for(let i = 0; i<main_text.length; i++){
				if(main_text[i].includes("--") && !main_text[i].includes("-->")){
					main_text[i] = main_text[i].replace(" --", "--"); // remove space
					main_text[i] = main_text[i].replace("-- ", "--"); // remove space
					main_text[i] = main_text[i].replace("--", "—");
					mainold_text[i] = main_text[i];
				}
			}
		}
	}else{
		for(let i = 0; i<main_text.length; i++){
			main_text[i] = main_text[i].replace("—", "--"); // remove space
			mainold_text[i] = main_text[i];
		}
	}
}

function InitialFix(){
	for(let i = 0; i<main_text.length; i++){
		main_text[i] = main_text[i].replace(/  +/g, " "); //fix multi spaces
		mainold_text[i] = main_text[i];
	}
	
	//mainold_text = main_text;
}

function FixTrails(){
	for(let i = 0; i<main_text.length; i++){
		main_text[i] = main_text[i].replace(/!!+/g, "!");
		main_text[i] = main_text[i].replace(/[?]+/g, "?");
		main_text[i] = main_text[i].replace(/[,]+/g, ",");
		//main_text[i] = main_text[i].replace(/[\[]+/g, "[");
		//main_text[i] = main_text[i].replace(/[\]]+/g, "]");
	}
}

function hasChanged(i){
	for(let j = 0; j<srtline[i].original_dialogs.length; j++){
		if(srtline[i].original_dialogs[j]!=srtline[i].dialogs[j]){
			return true;
		}
	}
	
	return false;
}

function displayTable(){
	// display sa table
	//$("#table").append(row);
	
	for(let i = 0; i<srtline.length; i++){
		
		if(document.getElementById("sel_lines").value=="line32"){
			for(let j = 0; j<srtline[i].original_dialogs.length; j++){
				if(srtline[i].original_dialogs[j].length > 32){
					srtline[i].note += srtline[i].original_dialogs[j].length+" Lines."
				}
			}
		}else if(document.getElementById("sel_lines").value=="line42"){
			for(let j = 0; j<srtline[i].original_dialogs.length; j++){
				if(srtline[i].original_dialogs[j].length > 42){
					srtline[i].note += srtline[i].original_dialogs[j].length+" Lines."
				}
			}
		}
	
	
		let dialogs = "<font color=white>";
		for(let j = 0; j<srtline[i].original_dialogs.length; j++){
			dialogs += "<br>"+srtline[i].original_dialogs[j];
		}
		
		
		let dialogs2 = "<td>";
		dialogs2+="<br>"
		dialogs2+="<br>"
		
		dialogs2 += "<font color=white>"
		
		for(let j = 0; j<srtline[i].dialogs.length; j++){
			dialogs2 += "<br>";
		}
		dialogs2 +=""
		dialogs2 +="<hr color=181818>"
		dialogs2 +="</td>"
		
		if (hasChanged(i)){
			dialogs2 = "<td>"
			dialogs2+="<b><font color=lightgreen></font>"
			dialogs2+="<br><font color=white></font>"
			
			dialogs2 += "<font color=green>"+srtline[i].note+"</font><font color=white>"
			
			for(let j = 0; j<srtline[i].dialogs.length; j++){
				dialogs2 += "<br>"+srtline[i].dialogs[j];
			}
			dialogs2 +=""
			dialogs2 +="<hr color=181818>"
			dialogs2 +="</td>"
		}
		
		var row = $("<tr><td><b><font color=lightgreen>" +srtline[i].id +"</b></font>"
		+"<br><font color=gold>" +srtline[i].duration[0] +" → " +srtline[i].duration[1]+"</font>"
		+dialogs
		+"<hr color=181818>"
		+"</td>"
		
		+dialogs2
		+"</tr>");
		$("#table").append(row);
		$("#table").focus();
	}
	
	/*
	for(let i = 0; i<main_text.length; i++){
		
		if(document.getElementById("linelimit32").checked == true && mainold_text[i].length > 33){
			mainold_text[i]="<b><font color='#ff0000'>["+mainold_text[i].length+"]</font></b><font color=#ff5500>"+mainold_text[i]+"</font>";
		}
	
		if(mainold_text[i] != main_text[i]){
			var row = $("<tr><td><font color=white>"
			+mainold_text[i]+"</font></td><td>"
			+main_text[i]
			+"</td><td>scanned</td></tr>");
			$("#table").append(row);
		}else{
			var row = $("<tr><td>"+mainold_text[i]+"</td><td>"+main_text[i]+"</td><td></td></tr>");
			$("#table").append(row);
		}
	}*/
}

class SRTLine {
  constructor() {
	this.id = 0; //so it won't start with 0
    this.duration = "";
    this.note = "";
	this.original_dialogs = [];
    this.dialogs = [];
	this.isChanged = false;
  }
}

let openFile = function(event) {
	let input = event.target;
	let reader = new FileReader();
	reader.readAsText(input.files[0]);
	let filename = input.files[0].name.replace(input.files[0].name.substr(input.files[0].name.length-4),"");
	
	switch(document.getElementById("mode").value){
		case "mode_standard":
			filename += "_CLEAN.srt";
			break;
		case "mode_ahd":
			filename += "_FOR_AHD.srt";
			break;
		case "mode_grammar":
			filename += "_FOR_GRAMMAR.srt";
			break;
	}
	
	reader.onload = function(){
		let text = reader.result.trim();
		main_text = text.split("\n");
		
		let i=0;
		let id=1;
		while(i<main_text.length){
			if (main_text[i].trim()!=""){
				let sub = new SRTLine();
				srtline.push(sub);
				sub.id = id; //main_text[i];
				id+=1;
				
				i++;
				if(i<main_text.length){
					sub.duration = main_text[i].split(" --> ");
				}
				
				i++;
				while(i<main_text.length){
					if(main_text[i].trim()!=""){ 
						sub.original_dialogs.push(main_text[i].trim());
						sub.dialogs.push(main_text[i].trim());
					}else{
						break;
					}
					i++;
				}	
			}
			i++;
		}
		
		/*
		for(let i = 0; i<srtline.length; i++){
			console.log( srtline[i].id );
			console.log( srtline[i].duration[0] +" --> "+ srtline[i].duration[1]);
			
			for(let j = 0; j<srtline[i].dialogs.length; j++){
				console.log( srtline[i].dialogs[j] );
			}
			
		}*/
		
		InitialFix();
		
		// EnsureCapitalization();
		FixTrails();
		implementFilters();
		specialTags();
		
		convertMusicNote();
		//convertEmDash();
		capitalHIs(document.getElementById("upperhi").checked);
		
		let newsrt = [];
		if (document.getElementById("mode").value == "mode_grammar"){
			var ln = "";
			for(let i = 0; i<srtline.length; i++){
				ln+=srtline[i].id+". ";
				//newsrt.push( srtline[i].duration[0] +" --> "+ srtline[i].duration[1]);
				
				var d = "";
				for(let j = 0; j<srtline[i].dialogs.length; j++){
					d+=srtline[i].dialogs[j].replace("\\n","")+" ";
				}
				var rep = d.match(/\{(.*?)\}/);
				if (rep!=null){
					console.log(rep[0])
					d=d.replace(rep[0],"");
				}
				
				d=d.replace("<i>♪ ","");
				d=d.replace(" ♪</i>","");
				
				newsrt.push(ln.trim()+d.trim());
				ln = "";
			}
		}else{
			for(let i = 0; i<srtline.length; i++){
				newsrt.push( srtline[i].id );
				newsrt.push( srtline[i].duration[0] +" --> "+ srtline[i].duration[1]);
				
				for(let j = 0; j<srtline[i].dialogs.length; j++){
					newsrt.push( srtline[i].dialogs[j] );
				}
				newsrt.push("");
				
			}
		}
		
		displayTable();
		
		createDownloadLink(newsrt.join("\n"), filename, 'text/plain');
		
		let gfg_down = document.getElementById("div_emdash");
		gfg_down.parentNode.removeChild(gfg_down);
	};
};

function createDownloadLink(txt, name, type) {
	var file = new Blob([txt], {type: type});
	$("#input").remove();
	let link = $("<a>");
	link.attr("id","a").text("Download "+name+" here");
	$("#div_link").append(link);
	$("#a").attr("href", URL.createObjectURL(file)).attr("download", name);
}

/*<input type="checkbox" id="EmDash" name="emdash" unchecked />
			<label for="EmDash">Double Hypen To Em Dash <font color=#ff0000><b>(Don't use for SCC!)</b></font></label>
			<br>*/

</script>
</head>

<body bgcolor="222222"><font color=white>
<div id="div_table">
	<table id="tablemenu">
		<div id="div_emdash">
			<select id='sel_lines'>
				<option value='line32'>Check 32 lines (SCC)</option>
				<option value='line42'>Check 42 lines (SRT)</option>
			</select>
			<br>
			
			<input type='radio' id='lowerhi' name='special' checked />
			<label for='lowerhi'><b>Lowercase HIs<b></label>
			
			<input type='radio' id='upperhi' name='special' unchecked />
			<label for='upperhi'><b>Uppercase HIs<b></label>
			<hr>
		
			
			
			<label for="mode">Select Convertion Mode</label>
			<br>
			<select id='mode'>
				<option value='mode_standard'>Standard Clean</option>
				<option value='mode_ahd'>AHD Format</option>
				<option value='mode_grammar'>For Grammar Checking</option>
			</select>

		</div>
	</table>

	<pre><table id="table" border=0 width=700 class="blueTable" contenteditable=true>
		<col width=400><col width=500 height=20><col width=100>
	</table></pre>
</div>
<div id="div_link">
	</span><input id="input" type="file" accept=".srt" onchange="openFile(event)"><br>
</div>
<br>

</font></body>
</html>